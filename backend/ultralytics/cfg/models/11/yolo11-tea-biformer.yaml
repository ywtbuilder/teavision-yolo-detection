# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license
# YOLO11-Tea-BiFormer: èŒ¶å¶æ£€æµ‹æ¨¡å‹ (BiFormer + SCGC æ”¹è¿›ç‰ˆ)
# 
# æ”¹è¿›ç‚¹:
# 1. BiLevelRoutingAttention (BRA): åŒå±‚è·¯ç”±æ³¨æ„åŠ›ï¼ŒåŠ¨æ€ç¨€ç–æ³¨æ„åŠ›ï¼Œå¤æ‚åº¦ O((HW)^{4/3})
# 2. C2fBRA: ç»“åˆ C2f ç‰¹å¾èåˆ + BRA å…¨å±€å»ºæ¨¡
# 3. C2fBRASCGC: C2fBRA + SCGC è‡ªæ ¡æ­£åˆ†ç»„å·ç§¯ (æŠ—å™ªå£°)
# 4. 4å°ºåº¦æ£€æµ‹å¤´ (P2-P5): å¢å¼ºå°ç›®æ ‡èŒ¶èŠ½æ£€æµ‹
#
# è®ºæ–‡å‚è€ƒ:
# - BiFormer: Vision Transformer with Bi-Level Routing Attention (CVPR 2023)
# - YOLO-TBD: Tea Bud Detection with TBAM and SCGC

# Parameters
nc: 80  # number of classes
scales:
  # [depth, width, max_channels]
  n: [0.50, 0.25, 1024]  # YOLO11n
  s: [0.50, 0.50, 1024]  # YOLO11s
  m: [0.50, 1.00, 512]   # YOLO11m
  l: [1.00, 1.00, 512]   # YOLO11l
  x: [1.00, 1.50, 512]   # YOLO11x

# YOLO11-Tea-BiFormer backbone
backbone:
  # [from, repeats, module, args]
  # P1/2 - åˆå§‹ç‰¹å¾æå–
  - [-1, 1, Conv, [64, 3, 2]]           # 0: (B,3,640,640) -> (B,64,320,320)
  
  # P2/4 - æµ…å±‚ç‰¹å¾ (ä¿ç•™ç”¨äºå°ç›®æ ‡æ£€æµ‹)
  - [-1, 1, Conv, [128, 3, 2]]          # 1: -> (B,128,160,160)
  - [-1, 2, C3k2, [128, False, 0.25]]   # 2: P2 ç‰¹å¾
  
  # P3/8 - ä¸­å±‚ç‰¹å¾ + BRA æ³¨æ„åŠ›
  - [-1, 1, Conv, [256, 3, 2]]          # 3: -> (B,256,80,80)
  - [-1, 2, C2fBRA, [256, False, 8, 4]] # 4: P3 + BRA (n_win=8, topk=4)
  
  # P4/16 - æ·±å±‚ç‰¹å¾ + BRA + SCGC
  - [-1, 1, Conv, [512, 3, 2]]          # 5: -> (B,512,40,40)
  - [-1, 2, C2fBRASCGC, [512, False, 8, 4]]  # 6: P4 + BRA + SCGC
  
  # P5/32 - æœ€æ·±å±‚ç‰¹å¾
  - [-1, 1, Conv, [1024, 3, 2]]         # 7: -> (B,1024,20,20)
  - [-1, 2, C2fBRASCGC, [1024, False, 4, 4]] # 8: P5 + BRA + SCGC (å°ç‰¹å¾å›¾ç”¨ n_win=4)
  - [-1, 1, SPPF, [1024, 5]]            # 9: SPPF å¤šå°ºåº¦æ± åŒ–
  - [-1, 2, C2PSA, [1024]]              # 10: PSA æ³¨æ„åŠ›

# YOLO11-Tea-BiFormer head (æ”¹è¿›çš„ PAFPN + 4å°ºåº¦æ£€æµ‹)
head:
  # ä¸Šé‡‡æ ·è·¯å¾„ (Top-Down)
  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 11: -> 40x40
  - [[-1, 6], 1, Concat, [1]]                    # 12: èåˆ P4
  - [-1, 2, C2fBRA, [512, False, 8, 4]]         # 13: P4 èåˆ + BRA

  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 14: -> 80x80
  - [[-1, 4], 1, Concat, [1]]                    # 15: èåˆ P3
  - [-1, 2, C2fBRA, [256, False, 8, 4]]         # 16: P3 èåˆ + BRA

  - [-1, 1, nn.Upsample, [None, 2, "nearest"]]  # 17: -> 160x160
  - [[-1, 2], 1, Concat, [1]]                    # 18: èåˆ P2
  - [-1, 2, C3k2, [128, False, 0.25]]           # 19: P2 èåˆ (å°ç›®æ ‡ä¸“ç”¨)

  # ä¸‹é‡‡æ ·è·¯å¾„ (Bottom-Up)
  - [-1, 1, Conv, [128, 3, 2]]                   # 20: -> 80x80
  - [[-1, 16], 1, Concat, [1]]                   # 21: èåˆ
  - [-1, 2, C2fBRA, [256, False, 8, 4]]         # 22: P3 è¾“å‡º + BRA

  - [-1, 1, Conv, [256, 3, 2]]                   # 23: -> 40x40
  - [[-1, 13], 1, Concat, [1]]                   # 24: èåˆ
  - [-1, 2, C2fBRASCGC, [512, False, 8, 4]]     # 25: P4 è¾“å‡º + BRA + SCGC

  - [-1, 1, Conv, [512, 3, 2]]                   # 26: -> 20x20
  - [[-1, 10], 1, Concat, [1]]                   # 27: èåˆ
  - [-1, 2, C2fBRASCGC, [1024, False, 4, 4]]    # 28: P5 è¾“å‡º + BRA + SCGC

  # 4å°ºåº¦æ£€æµ‹å¤´ (P2, P3, P4, P5)
  - [[19, 22, 25, 28], 1, Detect, [nc]]          # 29: Detect (P2, P3, P4, P5)
