# Ultralytics ğŸš€ AGPL-3.0 License - https://ultralytics.com/license

# YOLO26-D: Ultimate Small Object Detection model
# 
# æ ¸å¿ƒæ”¹è¿›æŠ€æœ¯ (å‡æ¥è‡ªé¡¶çº§ä¼šè®®è®ºæ–‡):
# 1. SPD-Conv (CVPR 2022) - æ— æŸä¸‹é‡‡æ ·ï¼Œä¿ç•™å°ç›®æ ‡å…¨éƒ¨åƒç´ ä¿¡æ¯
# 2. CARAFE (ICCV 2019) - å†…å®¹æ„ŸçŸ¥ä¸Šé‡‡æ ·ï¼Œç²¾å‡†è¿˜åŸå°ç›®æ ‡ç‰¹å¾
# 3. P2 å››å°ºåº¦æ£€æµ‹ - å¢åŠ  160x160 è¶…å¤§ç‰¹å¾å›¾ï¼Œä¸“æ”»æå°ç›®æ ‡
#
# è®¾è®¡åŸåˆ™:
# - Backbone: ä½¿ç”¨ SPD-Conv æ›¿ä»£ stride=2 ä¸‹é‡‡æ ·ï¼Œä¿ç•™æ›´å¤šç»†èŠ‚
# - Neck: ä½¿ç”¨ CARAFE æ›¿ä»£æ™®é€šä¸Šé‡‡æ ·ï¼Œå†…å®¹æ„ŸçŸ¥ç‰¹å¾é‡ç»„
# - Head: å››å°ºåº¦æ£€æµ‹ (P2/P3/P4/P5)ï¼Œè¦†ç›–å„ç§å¤§å°ç›®æ ‡
#
# Usage:
#   from ultralytics import YOLO
#   model = YOLO('yolo26-spdcarafe.yaml')
#   model.train(data='tea.yaml', epochs=150, imgsz=640)

# Parameters
nc: 80  # number of classes (modify to your dataset, e.g., 1 for tea bud)
end2end: True  # whether to use end-to-end mode
reg_max: 1  # DFL bins
scales: # model compound scaling constants
  # [depth, width, max_channels]
  n: [0.50, 0.25, 1024]  # YOLO26-D-N (Nano)
  s: [0.50, 0.50, 1024]  # YOLO26-D-S (Small, æ¨è)
  m: [0.50, 1.00, 512]   # YOLO26-D-M (Medium)
  l: [1.00, 1.00, 512]   # YOLO26-D-L (Large)
  x: [1.00, 1.50, 512]   # YOLO26-D-X (XLarge)

# YOLO26-D backbone with SPD-Conv lossless downsampling
backbone:
  # [from, repeats, module, args]
  - [-1, 1, Conv, [64, 3, 2]]             # 0-P1/2 (initial conv)
  - [-1, 1, Conv, [128, 3, 2]]            # 1-P2/4
  - [-1, 2, C3k2, [256, False, 0.25]]     # 2 (P2 features - 160x160 for 640 input)
  
  # P3: ä½¿ç”¨ SPD-Conv æ— æŸä¸‹é‡‡æ ·
  - [-1, 1, SPDConv, [256]]               # 3-P3/8 <-- SPD ä¸‹é‡‡æ · (æ— ä¿¡æ¯æŸå¤±)
  - [-1, 2, C3k2, [512, False, 0.25]]     # 4
  
  # P4: ä½¿ç”¨ SPD-Conv æ— æŸä¸‹é‡‡æ ·
  - [-1, 1, SPDConv, [512]]               # 5-P4/16 <-- SPD ä¸‹é‡‡æ ·
  - [-1, 2, C3k2, [512, True]]            # 6
  
  # P5: ä½¿ç”¨ SPD-Conv æ— æŸä¸‹é‡‡æ ·
  - [-1, 1, SPDConv, [1024]]              # 7-P5/32 <-- SPD ä¸‹é‡‡æ ·
  - [-1, 2, C3k2, [1024, True]]           # 8
  - [-1, 1, SPPF, [1024, 5, 3, True]]     # 9 (SPPF)
  - [-1, 2, C2PSA, [1024]]                # 10 (Attention)

# YOLO26-D head with CARAFE content-aware upsampling
head:
  # Top-down path with CARAFE
  - [-1, 1, CARAFE, [1024, 2]]            # 11 <-- CARAFE å†…å®¹æ„ŸçŸ¥ä¸Šé‡‡æ ·
  - [[-1, 6], 1, Concat, [1]]             # 12 cat backbone P4 (layer 6)
  - [-1, 2, C3k2, [512, True]]            # 13 (P4 fusion)

  - [-1, 1, CARAFE, [512, 2]]             # 14 <-- CARAFE
  - [[-1, 4], 1, Concat, [1]]             # 15 cat backbone P3 (layer 4)
  - [-1, 2, C3k2, [256, True]]            # 16 (P3/8-small)

  # P2 feature fusion (å…³é”®: æå°ç›®æ ‡æ£€æµ‹)
  - [-1, 1, CARAFE, [256, 2]]             # 17 <-- CARAFE
  - [[-1, 2], 1, Concat, [1]]             # 18 cat backbone P2 (layer 2)
  - [-1, 2, C3k2, [128, True]]            # 19 (P2/4-xsmall) <-- è¶…å¤§ç‰¹å¾å›¾

  # Bottom-up path
  - [-1, 1, Conv, [128, 3, 2]]            # 20
  - [[-1, 16], 1, Concat, [1]]            # 21 cat head P3
  - [-1, 2, C3k2, [256, True]]            # 22 (P3/8-small)

  - [-1, 1, Conv, [256, 3, 2]]            # 23
  - [[-1, 13], 1, Concat, [1]]            # 24 cat head P4
  - [-1, 2, C3k2, [512, True]]            # 25 (P4/16-medium)

  - [-1, 1, Conv, [512, 3, 2]]            # 26
  - [[-1, 10], 1, Concat, [1]]            # 27 cat head P5
  - [-1, 1, C3k2, [1024, True, 0.5, True]] # 28 (P5/32-large)

  # Detect head: P2, P3, P4, P5 (4-scale detection)
  - [[19, 22, 25, 28], 1, Detect, [nc]]   # Detect(P2, P3, P4, P5)
